!function(){"use strict";var e=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}();function t(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var n={};n.util={};var i=function(){function n(){t(this,n),this.eventList={},this.activeEvents=!0}return e(n,[{key:"on",value:function(e,t){null==this.eventList[e]&&(this.eventList[e]=[]),this.eventList[e].push(t)}},{key:"once",value:function(e,t){var n=this;this.on(e,function i(s){t(s),n.removeListener(e,i)})}},{key:"any",value:function(e){this.on("*",e)}},{key:"emit",value:function(e,t){if(!this.activeEvents)return 0;var n=void 0;if(this.eventList[e]&&this.eventList["*"])n=this.eventList[e].concat(this.eventList["*"]);else if(this.eventList[e])n=this.eventList[e];else{if(!this.eventList["*"])return 0;n=this.eventList["*"]}for(var i=0;i<n.length;i++)n[i](e,t);return n.length}},{key:"removeListener",value:function(e,t){if(this.eventList[e]){var n=this.eventList[e].indexOf(t);n>-1&&this.eventList.splice(n,1)}}}]),n}();n.util.EventEmitter=i;var s=function(n){function s(){t(this,s);var e=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}(this,(s.__proto__||Object.getPrototypeOf(s)).call(this,"WebSocket-builtin"));return e.currentPosition=0,e.paused=!0,e.doSeek=!1,e.isReady=!1,e.roomdetails={},e.clientIgnoringOnTheFly=0,e.serverIgnoringOnTheFly=0,e.pingService=new PingService,e.serverPosition=0,e}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}(s,i),e(s,[{key:"connect",value:function(e,t){var n=this;this.socket=new WebSocket(e.url),this.socket.addEventListener("open",function(){t(),e.password?n.sendHello(e.name,e.room,e.password):n.sendHello(e.name,e.room),n.sendReady(),n.sendListRequest(),n.currentFile&&n.sendFile()}),this.socket.addEventListener("message",function(e){n.emit("message",e.data),e.data.split("\n").forEach(function(e){null!=e&&(e.length<1||n.parseMessage(e))})})}},{key:"disconnect",value:function(){this.socket&&this.socket.close()}},{key:"sendData",value:function(e){this.socket.send(JSON.stringify(e))}},{key:"setTime",value:function(e){this.currentPosition=e}},{key:"seekTo",value:function(e){this.setTime(e),this.doSeek=!0,this.sendState()}},{key:"setPause",value:function(e){this.paused=e,e||this.isReady||(this.isReady=!0,this.sendReady()),this.sendState()}},{key:"sendFile",value:function(e,t){t&&(e||(e=0),this.currentFile={duration:e,name:t,size:0}),this.sendData({Set:{file:this.currentFile}}),this.sendListRequest()}},{key:"sendReady",value:function(e){void 0!=e&&null!=e||(e=this.isReady);var t={Set:{ready:{isReady:e,manuallyInitiated:!0,username:this.currentUsername}}};this.sendData(t)}},{key:"parseMessage",value:function(e){var t=JSON.parse(e);console.log("SERVER:",t),t.Error&&this.parseError(t.Error),t.Hello&&this.parseHello(t.Hello),t.Set&&this.parseSet(t.Set),t.List&&this.parseList(t.List),t.State&&this.parseState(t.State),t.Chat&&this.parseChat(t.Chat),this.sendState()}},{key:"parseError",value:function(e){console.log("err",e)}},{key:"parseHello",value:function(e){console.log("hello",e),this.serverDetails={version:e.version,realversion:e.realversion,features:e.features,motd:e.motd};var t="Connected to server, version "+e.version+".";e.motd&&(t+=" MOTD:\n\t\t\t"+e.motd),this.emit("connected",t)}},{key:"parseSet",value:function(e){var t=this;console.log("set",e),e.user&&Object.keys(e.user).forEach(function(n){var i=e.user[n];i.event?(i.event.joined&&(t.emit("joined",n),t.roomdetails[n]={room:i.room.name}),i.event.left&&(t.emit("left",n),delete t.roomdetails[n])):t.roomdetails[n]&&t.roomdetails[n].room!=i.room.name&&(t.roomdetails[n].room=i.room.name,t.emit("moved",{user:n,room:i.room.name})),i.file&&(t.roomdetails[n].file=i.file),t.emit("roomdetails",t.roomdetails)}),e.ready&&(this.roomdetails[e.ready.username].isReady=e.ready.isReady,this.roomdetails[e.ready.username].manuallyInitiated=e.ready.manuallyInitiated,this.emit("roomdetails",this.roomdetails))}},{key:"parseList",value:function(e){var t=this;this.roomdetails={},Object.keys(e).forEach(function(n){Object.keys(e[n]).forEach(function(i){t.roomdetails[i]=e[n][i],t.roomdetails[i].room=n})}),this.emit("roomdetails",e)}},{key:"parseState",value:function(e){var t=0;e.ignoringOnTheFly&&e.ignoringOnTheFly.server&&(this.serverIgnoringOnTheFly=e.ignoringOnTheFly.server,this.clientIgnoringOnTheFly=0,this.stateChanged=!1),e.playstate&&(e.playstate.setBy&&e.playstate.setBy!=this.currentUsername&&(e.playstate.doSeek&&!this.doSeek&&this.emit("seek",e.playstate.position),this.paused!=e.playstate.paused&&(e.playstate.paused?(this.emit("pause"),this.paused=!0):(this.emit("unpause"),this.paused=!1))),e.playstate.position&&(this.serverPosition=e.playstate.position)),e.ping&&(e.ping.latencyCalculation&&(this.latencyCalculation=e.ping.latencyCalculation),e.ping.clientLatencyCalculation&&this.pingService.receiveMessage(e.ping.clientLatencyCalculation,e.ping.serverRtt),t=this.pingService.getLastForwardDelay()),this.paused||(this.serverPosition+=t)}},{key:"parseChat",value:function(e){this.emit("chat",{name:e.username,message:e.message})}},{key:"sendState",value:function(){var e=0==this.clientIgnoringOnTheFly||0!=this.serverIgnoringOnTheFly,t={};t.State={},e&&(t.State.playstate={},t.State.playstate.position=this.currentPosition,t.State.playstate.paused=this.paused,this.doSeek&&(t.State.playstate.doSeek=!0,this.doSeek=!1)),t.State.ping={},this.latencyCalculation&&(t.State.ping.latencyCalculation=this.latencyCalculation),t.State.ping.clientLatencyCalculation=Date.now()/1e3,t.State.ping.clientRtt=this.pingService.getRTT(),this.stateChanged&&(this.clientIgnoringOnTheFly+=1),(this.serverIgnoringOnTheFly>0||this.clientIgnoringOnTheFly>0)&&(t.State.ignoringOnTheFly={},this.serverIgnoringOnTheFly>0&&(t.State.ignoringOnTheFly.server=this.serverIgnoringOnTheFly,this.serverIgnoringOnTheFly=0),this.clientIgnoringOnTheFly>0&&(t.State.ignoringOnTheFly.client=this.clientIgnoringOnTheFly)),console.log(t),this.sendData(t)}},{key:"sendHello",value:function(e,t,n){this.currentUsername=e,this.currentRoom=t;var i={Hello:{username:e,room:{name:t},version:"1.5.1"}};n&&(i.Hello.password=n),this.sendData(i)}},{key:"sendListRequest",value:function(){this.sendData({List:null})}}]),s}();n.Client=s,window.SyncWeb=n}();
//# sourceMappingURL=syncweb.min.js.map
