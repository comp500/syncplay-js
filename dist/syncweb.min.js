!function(){"use strict";var e=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}();function t(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function n(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var s={};s.util={};var o={get:function(e,t){return"string"==typeof t?e.find(function(e){return e.name==t}):e.includes(t)?t:void 0},remove:function(e,t){var n=void 0;(n="string"==typeof t?e.findIndex(function(e){return e.name==t}):e.indexOf(t))>-1&&e.splice(n,1)}};s.util.ArrayHandlers=o;var r=function(){function t(){i(this,t),this.eventList={},this.activeEvents=!0}return e(t,[{key:"on",value:function(e,t){null==this.eventList[e]&&(this.eventList[e]=[]),this.eventList[e].push(t)}},{key:"once",value:function(e,t){var n=this;this.on(e,function i(s){t(s),n.removeListener(e,i)})}},{key:"any",value:function(e){this.on("*",e)}},{key:"emit",value:function(e,t){if(!this.activeEvents)return 0;var n=void 0;if(this.eventList[e]&&this.eventList["*"])n=this.eventList[e].concat(this.eventList["*"]);else if(this.eventList[e])n=this.eventList[e];else{if(!this.eventList["*"])return 0;n=this.eventList["*"]}for(var i=0;i<n.length;i++)n[i](e,t);return n.length}},{key:"removeListener",value:function(e,t){if(this.eventList[e]){var n=this.eventList[e].indexOf(t);n>-1&&this.eventList.splice(n,1)}}}]),t}();s.util.EventEmitter=r;var a=function(s){function o(e){i(this,o);var n=t(this,(o.__proto__||Object.getPrototypeOf(o)).call(this));return n.name=e,n}return n(o,r),e(o,[{key:"initialise",value:function(e){this.client=e}}]),o}();s.Protocol=a;var l=function(s){function o(e){i(this,o);var n=t(this,(o.__proto__||Object.getPrototypeOf(o)).call(this));return n.name=e,n}return n(o,r),e(o,[{key:"initialise",value:function(e){this.client=e}}]),o}();s.Player=l;var c=function(){function t(e){i(this,t),this.name=e}return e(t,[{key:"initialise",value:function(e){this.client=e}}]),t}();s.PlayerProxy=c;var u=[],h=[],y=[],v=function(s){function a(e){i(this,a);var n=t(this,(a.__proto__||Object.getPrototypeOf(a)).call(this));return n.protocolList=u,n.playerList=y,n.playerProxyList=h,n.state=0,n.playerElement=e,n.playerList.forEach(function(e){e.initialise(n)}),n.playerProxyList.forEach(function(e){e.initialise(n)}),n.protocolList.forEach(function(e){e.initialise(n)}),n}return n(a,r),e(a,[{key:"addProtocol",value:function(e){this.protocolList.push(e),e.initialise(this)}},{key:"getProtocol",value:function(e){return o.get(this.protocolList,e)}},{key:"removeProtocol",value:function(e){o.remove(this.protocolList,e)}},{key:"addPlayer",value:function(e){this.playerList.push(e),e.initialise(this)}},{key:"getPlayer",value:function(e){return o.get(this.playerList,e)}},{key:"removePlayer",value:function(e){o.remove(this.playerList,e)}},{key:"addPlayerProxy",value:function(e){this.playerProxyList.push(e),e.initialise(this)}},{key:"getPlayerProxy",value:function(e){return o.get(this.playerProxyList,e)}},{key:"removePlayerProxy",value:function(e){o.remove(this.playerProxyList,e)}},{key:"connect",value:function(e,t){var n=this;if(0!=this.state)throw new Error("Client is currently connected, must disconnect first before reconnecting.");var i=this.getProtocol(e);if(void 0==i||!i)throw new Error("No protocol of that name is loaded!");this.currentProtocol=i,this.state=1,this.proxyEvents("connecting",e),i.any(this.proxyEvents.bind(this)),i.on("seturl",function(e,t){n.setURL(t)}),i.connect(t,function(){1==n.state&&(n.state=2,n.proxyEvents("connected"))})}},{key:"proxyEvents",value:function(e,t){for(var n=0;n<this.playerProxyList.length;n++)this.playerProxyList[n].event(e,t);this.currentPlayer&&this.currentPlayer.event(e,t)}},{key:"proxyEventsToProtocol",value:function(e,t){for(var n=0;n<this.playerProxyList.length;n++)this.playerProxyList[n].event(e,t);this.currentProtocol&&this.currentProtocol.event(e,t)}},{key:"setURL",value:function(e){if(this.currentPlayer&&this.currentPlayer.supports(e))this.proxyEvents("seturl",e);else{var t=this.playerList.find(function(t){return t.supports(e)});if(!t)throw new Error("No players to handle URL available");this.currentPlayer&&this.currentPlayer.event("terminate"),this.currentPlayer=t,this.currentPlayer.any(this.proxyEventsToProtocol.bind(this)),this.proxyEvents("seturl",e)}}}],[{key:"addStaticProtocol",value:function(e){u.push(e)}},{key:"getStaticProtocol",value:function(e){return o.get(u,e)}},{key:"removeStaticProtocol",value:function(e){o.remove(u,e)}},{key:"addStaticPlayer",value:function(e){y.push(e)}},{key:"getStaticPlayer",value:function(e){return o.get(y,e)}},{key:"removeStaticPlayer",value:function(e){o.remove(y,e)}},{key:"addStaticPlayerProxy",value:function(e){h.push(e)}},{key:"getStaticPlayerProxy",value:function(e){return o.get(h,e)}},{key:"removeStaticPlayerProxy",value:function(e){o.remove(h,e)}}]),a}();s.Client=v;var f=function(o){function r(){i(this,r);var e=t(this,(r.__proto__||Object.getPrototypeOf(r)).call(this,"WebSocket-builtin"));return e.currentPosition=0,e.paused=!0,e.doSeek=!1,e.isReady=!1,e}return n(r,s.Protocol),e(r,[{key:"connect",value:function(e,t){var n=this;this.socket=new WebSocket(e.url),this.socket.addEventListener("open",function(){t(),e.password?n.sendHello(e.name,e.room,e.password):n.sendHello(e.name,e.room),n.sendReady()}),this.socket.addEventListener("message",function(e){n.emit("message",e.data),e.data.split("\n").forEach(function(e){null!=e&&(e.length<1||n.parseMessage(e))})})}},{key:"event",value:function(e,t){switch(console.log("event: ",e,t),e){case"send":this.socket.send(JSON.stringify(t));break;case"setmeta":this.sendFile(t.duration,t.name);break;case"settime":this.currentPosition=t;break;case"seek":this.currentPosition=t,this.doSeek=!0,this.sendState();break;case"pause":this.paused=!0,this.sendState();break;case"unpause":this.paused=!1,this.isReady||(this.isReady=!0,this.sendReady()),this.sendState()}}},{key:"parseMessage",value:function(e){var t=JSON.parse(e);if(console.log("SERVER:",t),t.Error&&console.log("err",t.Error),t.Hello){console.log("hello",t.Hello),this.serverDetails={version:t.Hello.version,realversion:t.Hello.realversion,features:t.Hello.features,motd:t.Hello.motd};var n="Connected to server, version "+t.Hello.version+".";t.Hello.motd&&(n+=" MOTD:\n\t\t\t\t"+t.Hello.motd),this.emit("connected",n)}t.Set&&console.log("set",t.Set),t.List&&(console.log("list",t.List),console.log("roomsList",Object.keys(t.List)),console.log("userList",Object.keys(t.List[this.currentRoom])),this.emit("roomdetails",t.List)),t.State&&(null!=t.State.ping.yourLatency&&(this.clientRtt=t.State.ping.yourLatency),this.latencyCalculation=t.State.ping.latencyCalculation,t.State.ignoringOnTheFly&&t.State.ignoringOnTheFly.server&&(this.serverIgnoringOnTheFly=t.State.ignoringOnTheFly.server,this.clientIgnoringOnTheFly=0,this.stateChanged=!1),t.State.playstate&&t.State.playstate.setBy&&t.State.playstate.setBy!=this.currentUsername&&(t.State.playstate.doSeek&&!this.doSeek&&this.emit("seek",t.State.playstate.position),this.paused!=t.State.playstate.paused&&(t.State.playstate.paused?(this.emit("pause"),this.paused=!0):(this.emit("unpause"),this.paused=!1)))),t.Chat&&this.emit("chat",{name:t.Chat.username,message:t.Chat.message}),this.sendState()}},{key:"sendState",value:function(){var e=0==this.clientIgnoringOnTheFly||0!=this.serverIgnoringOnTheFly,t={};t.State={},e&&(t.State.playstate={},t.State.playstate.position=this.currentPosition,t.State.playstate.paused=this.paused,this.doSeek&&(t.State.playstate.doSeek=!0,this.doSeek=!1)),t.State.ping={},t.State.ping.latencyCalculation=this.latencyCalculation,t.State.ping.clientLatencyCalculation=Date.now()/1e3,t.State.ping.clientRtt=this.clientRtt,this.stateChanged&&(this.clientIgnoringOnTheFly+=1),(this.serverIgnoringOnTheFly>0||this.clientIgnoringOnTheFly>0)&&(t.State.ignoringOnTheFly={},this.serverIgnoringOnTheFly>0&&(t.State.ignoringOnTheFly.server=this.serverIgnoringOnTheFly,this.serverIgnoringOnTheFly=0),this.clientIgnoringOnTheFly>0&&(t.State.ignoringOnTheFly.client=this.clientIgnoringOnTheFly)),console.log(t),this.event("send",t)}},{key:"sendHello",value:function(e,t,n){this.currentUsername=e,this.currentRoom=t;var i={Hello:{username:e,room:{name:t},version:"1.5.1"}};n&&(i.Hello.password=n),this.event("send",i)}},{key:"sendListRequest",value:function(){this.event("send",{List:null})}},{key:"sendReady",value:function(){var e={Set:{ready:{isReady:this.isReady,manuallyInitiated:!0,username:this.currentUsername}}};this.event("send",e)}},{key:"sendFile",value:function(e,t){e||(e=0);var n={duration:e,name:t,size:0};this.event("send",{Set:{file:n}})}}]),r}();s.Client.addStaticProtocol(new f),window.SyncWeb=s}();
//# sourceMappingURL=syncweb.min.js.map
