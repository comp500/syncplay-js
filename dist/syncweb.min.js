!function(){"use strict";var e=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}();function t(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function n(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var o={};o.util={};var r={get:function(e,t){return"string"==typeof t?e.find(function(e){return e.name==t}):e.includes(t)?t:void 0},remove:function(e,t){var n=void 0;(n="string"==typeof t?e.findIndex(function(e){return e.name==t}):e.indexOf(t))>-1&&e.splice(n,1)}};o.util.ArrayHandlers=r;var s=function(){function t(){i(this,t),this.eventList={},this.activeEvents=!0}return e(t,[{key:"on",value:function(e,t){null==this.eventList[e]&&(this.eventList[e]=[]),this.eventList[e].push(t)}},{key:"once",value:function(e,t){var n=this;this.on(e,function i(o){t(o),n.removeListener(e,i)})}},{key:"any",value:function(e){this.on("*",e)}},{key:"emit",value:function(e,t){if(!this.activeEvents)return 0;var n=void 0;if(this.eventList[e]&&this.eventList["*"])n=this.eventList[e].concat(this.eventList["*"]);else if(this.eventList[e])n=this.eventList[e];else{if(!this.eventList["*"])return 0;n=this.eventList["*"]}for(var i=0;i<n.length;i++)n[i](e,t);return n.length}},{key:"removeListener",value:function(e,t){if(this.eventList[e]){var n=this.eventList[e].indexOf(t);n>-1&&this.eventList.splice(n,1)}}}]),t}();o.util.EventEmitter=s;var a=function(o){function r(e){i(this,r);var n=t(this,(r.__proto__||Object.getPrototypeOf(r)).call(this));return n.name=e,n}return n(r,s),e(r,[{key:"initialise",value:function(e){this.client=e}}]),r}();o.Protocol=a;var l=function(o){function r(e){i(this,r);var n=t(this,(r.__proto__||Object.getPrototypeOf(r)).call(this));return n.name=e,n}return n(r,s),e(r,[{key:"initialise",value:function(e){this.client=e}}]),r}();o.Player=l;var u=function(){function t(e){i(this,t),this.name=e}return e(t,[{key:"initialise",value:function(e){this.client=e}}]),t}();o.PlayerProxy=u;var c=[],h=[],y=[],v=function(o){function a(e){i(this,a);var n=t(this,(a.__proto__||Object.getPrototypeOf(a)).call(this));return n.protocolList=c,n.playerList=y,n.playerProxyList=h,n.state=0,n.playerElement=e,n.playerList.forEach(function(e){e.initialise(n)}),n.playerProxyList.forEach(function(e){e.initialise(n)}),n.protocolList.forEach(function(e){e.initialise(n)}),n}return n(a,s),e(a,[{key:"addProtocol",value:function(e){this.protocolList.push(e),e.initialise(this)}},{key:"getProtocol",value:function(e){return r.get(this.protocolList,e)}},{key:"removeProtocol",value:function(e){r.remove(this.protocolList,e)}},{key:"addPlayer",value:function(e){this.playerList.push(e),e.initialise(this)}},{key:"getPlayer",value:function(e){return r.get(this.playerList,e)}},{key:"removePlayer",value:function(e){r.remove(this.playerList,e)}},{key:"addPlayerProxy",value:function(e){this.playerProxyList.push(e),e.initialise(this)}},{key:"getPlayerProxy",value:function(e){return r.get(this.playerProxyList,e)}},{key:"removePlayerProxy",value:function(e){r.remove(this.playerProxyList,e)}},{key:"connect",value:function(e,t){var n=this;if(0!=this.state)throw new Error("Client is currently connected, must disconnect first before reconnecting.");var i=this.getProtocol(e);if(void 0==i||!i)throw new Error("No protocol of that name is loaded!");this.currentProtocol=i,this.state=1,this.proxyEvents("connecting",e),i.any(this.proxyEvents.bind(this)),i.on("seturl",function(e,t){n.setURL(t)}),i.connect(t,function(){1==n.state&&(n.state=2,n.proxyEvents("connected"))})}},{key:"proxyEvents",value:function(e,t){for(var n=0;n<this.playerProxyList.length;n++)this.playerProxyList[n].event(e,t);this.currentPlayer&&this.currentPlayer.event(e,t)}},{key:"proxyEventsToProtocol",value:function(e,t){for(var n=0;n<this.playerProxyList.length;n++)this.playerProxyList[n].event(e,t);this.currentProtocol&&this.currentProtocol.event(e,t)}},{key:"setURL",value:function(e){if(this.currentPlayer&&this.currentPlayer.supports(e))this.proxyEvents("seturl",e);else{var t=this.playerList.find(function(t){return t.supports(e)});if(!t)throw new Error("No players to handle URL available");this.currentPlayer&&this.currentPlayer.event("terminate"),this.currentPlayer=t,this.currentPlayer.any(this.proxyEventsToProtocol.bind(this)),this.proxyEvents("seturl",e)}}}],[{key:"addStaticProtocol",value:function(e){c.push(e)}},{key:"getStaticProtocol",value:function(e){return r.get(c,e)}},{key:"removeStaticProtocol",value:function(e){r.remove(c,e)}},{key:"addStaticPlayer",value:function(e){y.push(e)}},{key:"getStaticPlayer",value:function(e){return r.get(y,e)}},{key:"removeStaticPlayer",value:function(e){r.remove(y,e)}},{key:"addStaticPlayerProxy",value:function(e){h.push(e)}},{key:"getStaticPlayerProxy",value:function(e){return r.get(h,e)}},{key:"removeStaticPlayerProxy",value:function(e){r.remove(h,e)}}]),a}();o.Client=v;var d=function(r){function s(){i(this,s);var e=t(this,(s.__proto__||Object.getPrototypeOf(s)).call(this,"WebSocket-builtin"));return e.currentPosition=0,e.paused=!0,e.doSeek=!1,e.isReady=!1,e.roomdetails={},e}return n(s,o.Protocol),e(s,[{key:"connect",value:function(e,t){var n=this;this.socket=new WebSocket(e.url),this.socket.addEventListener("open",function(){t(),e.password?n.sendHello(e.name,e.room,e.password):n.sendHello(e.name,e.room),n.sendReady(),n.sendListRequest()}),this.socket.addEventListener("message",function(e){n.emit("message",e.data),e.data.split("\n").forEach(function(e){null!=e&&(e.length<1||n.parseMessage(e))})})}},{key:"event",value:function(e,t){switch(console.log("event: ",e,t),e){case"send":this.socket.send(JSON.stringify(t));break;case"setmeta":this.sendFile(t.duration,t.name);break;case"settime":this.currentPosition=t;break;case"seek":this.currentPosition=t,this.doSeek=!0,this.sendState();break;case"pause":this.paused=!0,this.sendState();break;case"unpause":this.paused=!1,this.isReady||(this.isReady=!0,this.sendReady()),this.sendState()}}},{key:"parseMessage",value:function(e){var t=this,n=JSON.parse(e);if(console.log("SERVER:",n),n.Error&&console.log("err",n.Error),n.Hello){console.log("hello",n.Hello),this.serverDetails={version:n.Hello.version,realversion:n.Hello.realversion,features:n.Hello.features,motd:n.Hello.motd};var i="Connected to server, version "+n.Hello.version+".";n.Hello.motd&&(i+=" MOTD:\n\t\t\t\t"+n.Hello.motd),this.emit("connected",i)}n.Set&&(console.log("set",n.Set),n.Set.user&&Object.keys(n.Set.user).forEach(function(e){var i=n.Set.user[e];if(i.event)i.event.joined&&(t.emit("joined",e),t.roomdetails[i.room.name]||(t.roomdetails[i.room.name]={}),t.roomdetails[i.room.name][e]={}),i.event.left&&(t.emit("left",e),delete t.roomdetails[i.room.name][e],0==Object.keys(t.roomdetails[i.room.name]).length&&delete t.roomdetails[i.room.name]);else if(t.roomdetails[i.room.name]&&t.roomdetails[i.room.name][e]);else{var o={};Object.keys(t.roomdetails).some(function(n){return Object.keys(t.roomdetails[n]).some(function(i){if(i==e)return o=t.roomdetails[n][i],delete t.roomdetails[n][i],0==Object.keys(t.roomdetails[n]).length&&delete t.roomdetails[n],!0})}),t.roomdetails[i.room.name]||(t.roomdetails[i.room.name]={}),t.roomdetails[i.room.name][e]=o,t.emit("moved",{user:e,room:i.room.name})}i.file&&(t.roomdetails[i.room.name][e].file=i.file),t.emit("roomdetails",t.roomdetails)}),n.Set.ready&&Object.keys(this.roomdetails).some(function(e){return Object.keys(t.roomdetails[e]).some(function(i){if(i==n.Set.ready.username)return t.roomdetails[e][n.Set.ready.username].isReady=n.Set.ready.isReady,t.roomdetails[e][n.Set.ready.username].manuallyInitiated=n.Set.ready.manuallyInitiated,t.emit("roomdetails",t.roomdetails),!0})})),n.List&&(this.roomdetails=n.List,this.emit("roomdetails",n.List)),n.State&&(null!=n.State.ping.yourLatency&&(this.clientRtt=n.State.ping.yourLatency),this.latencyCalculation=n.State.ping.latencyCalculation,n.State.ignoringOnTheFly&&n.State.ignoringOnTheFly.server&&(this.serverIgnoringOnTheFly=n.State.ignoringOnTheFly.server,this.clientIgnoringOnTheFly=0,this.stateChanged=!1),n.State.playstate&&n.State.playstate.setBy&&n.State.playstate.setBy!=this.currentUsername&&(n.State.playstate.doSeek&&!this.doSeek&&this.emit("seek",n.State.playstate.position),this.paused!=n.State.playstate.paused&&(n.State.playstate.paused?(this.emit("pause"),this.paused=!0):(this.emit("unpause"),this.paused=!1)))),n.Chat&&this.emit("chat",{name:n.Chat.username,message:n.Chat.message}),this.sendState()}},{key:"sendState",value:function(){var e=0==this.clientIgnoringOnTheFly||0!=this.serverIgnoringOnTheFly,t={};t.State={},e&&(t.State.playstate={},t.State.playstate.position=this.currentPosition,t.State.playstate.paused=this.paused,this.doSeek&&(t.State.playstate.doSeek=!0,this.doSeek=!1)),t.State.ping={},t.State.ping.latencyCalculation=this.latencyCalculation,t.State.ping.clientLatencyCalculation=Date.now()/1e3,t.State.ping.clientRtt=this.clientRtt,this.stateChanged&&(this.clientIgnoringOnTheFly+=1),(this.serverIgnoringOnTheFly>0||this.clientIgnoringOnTheFly>0)&&(t.State.ignoringOnTheFly={},this.serverIgnoringOnTheFly>0&&(t.State.ignoringOnTheFly.server=this.serverIgnoringOnTheFly,this.serverIgnoringOnTheFly=0),this.clientIgnoringOnTheFly>0&&(t.State.ignoringOnTheFly.client=this.clientIgnoringOnTheFly)),console.log(t),this.event("send",t)}},{key:"sendHello",value:function(e,t,n){this.currentUsername=e,this.currentRoom=t;var i={Hello:{username:e,room:{name:t},version:"1.5.1"}};n&&(i.Hello.password=n),this.event("send",i)}},{key:"sendListRequest",value:function(){this.event("send",{List:null})}},{key:"sendReady",value:function(){var e={Set:{ready:{isReady:this.isReady,manuallyInitiated:!0,username:this.currentUsername}}};this.event("send",e)}},{key:"sendFile",value:function(e,t){e||(e=0);var n={duration:e,name:t,size:0};this.event("send",{Set:{file:n}})}}]),s}();o.Client.addStaticProtocol(new d),window.SyncWeb=o}();
//# sourceMappingURL=syncweb.min.js.map
