!function(){"use strict";var e=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}();function t(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function n(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var o={};o.util={};var r={get:function(e,t){return"string"==typeof t?e.find(function(e){return e.name==t}):e.includes(t)?t:void 0},remove:function(e,t){var n=void 0;(n="string"==typeof t?e.findIndex(function(e){return e.name==t}):e.indexOf(t))>-1&&e.splice(n,1)}};o.util.ArrayHandlers=r;var s=function(){function t(){i(this,t),this.eventList={},this.activeEvents=!0}return e(t,[{key:"on",value:function(e,t){null==this.eventList[e]&&(this.eventList[e]=[]),this.eventList[e].push(t)}},{key:"once",value:function(e,t){var n=this;this.on(e,function i(o){t(o),n.removeListener(e,i)})}},{key:"any",value:function(e){this.on("*",e)}},{key:"emit",value:function(e,t){if(!this.activeEvents)return 0;var n=void 0;if(this.eventList[e]&&this.eventList["*"])n=this.eventList[e].concat(this.eventList["*"]);else if(this.eventList[e])n=this.eventList[e];else{if(!this.eventList["*"])return 0;n=this.eventList["*"]}for(var i=0;i<n.length;i++)n[i](e,t);return n.length}},{key:"removeListener",value:function(e,t){if(this.eventList[e]){var n=this.eventList[e].indexOf(t);n>-1&&this.eventList.splice(n,1)}}}]),t}();o.util.EventEmitter=s;var a=function(e){function o(e){i(this,o);var n=t(this,(o.__proto__||Object.getPrototypeOf(o)).call(this));return n.name=e,n}return n(o,s),o}();o.Protocol=a;o.Player=function e(t){i(this,e),this.name=t};o.PlayerProxy=function e(t){i(this,e),this.name=t};var l=[],c=[],u=[],h=function(o){function a(e){i(this,a);var n=t(this,(a.__proto__||Object.getPrototypeOf(a)).call(this));return n.protocolList=l,n.playerList=u,n.playerProxyList=c,n.state=0,n.playerElement=e,n.playerList.forEach(function(e){e.initialise(n)}),n}return n(a,s),e(a,[{key:"addProtocol",value:function(e){this.protocolList.push(e)}},{key:"getProtocol",value:function(e){return r.get(this.protocolList,e)}},{key:"removeProtocol",value:function(e){r.remove(this.protocolList,e)}},{key:"addPlayer",value:function(e){this.playerList.push(e)}},{key:"getPlayer",value:function(e){return r.get(this.playerList,e)}},{key:"removePlayer",value:function(e){r.remove(this.playerList,e)}},{key:"addPlayerProxy",value:function(e){this.playerProxyList.push(e)}},{key:"getPlayerProxy",value:function(e){return r.get(this.playerProxyList,e)}},{key:"removePlayerProxy",value:function(e){r.remove(this.playerProxyList,e)}},{key:"connect",value:function(e,t){var n=this;if(0!=this.state)throw new Error("Client is currently connected, must disconnect first before reconnecting.");var i=this.getProtocol(e);if(void 0==i||!i)throw new Error("No protocol of that name is loaded!");this.currentProtocol=i,this.state=1,this.proxyEvents("connecting",e),i.any(this.proxyEvents.bind(this)),i.on("seturl",function(e,t){n.setURL(t)}),i.connect(t,function(){1==n.state&&(n.state=2,n.proxyEvents("connected"))})}},{key:"proxyEvents",value:function(e,t){for(var n=0;n<this.playerProxyList.length;n++)this.playerProxyList[n].on(e,t);this.currentPlayer&&this.currentPlayer.on(e,t)}},{key:"proxyCommand",value:function(e,t){if(this.currentPlayer){for(var n=0;n<this.playerProxyList.length;n++)this.playerProxyList[n].command(e,t);this.currentPlayer.command(e,t)}}},{key:"proxyCommandToProtocol",value:function(e,t){if(this.currentPlayer){for(var n=0;n<this.playerProxyList.length;n++)this.playerProxyList[n].command(e,t);this.currentProtocol.command(e,t)}}},{key:"setURL",value:function(e){if(this.currentPlayer&&this.currentPlayer.supports(e))this.proxyCommand("seturl",e);else{var t=this.playerList.find(function(t){return t.supports(e)});if(!t)throw new Error("No players to handle URL available");this.currentPlayer&&this.currentPlayer.command("terminate"),this.currentPlayer=t,this.proxyCommand("seturl",e)}}}],[{key:"addStaticProtocol",value:function(e){l.push(e)}},{key:"getStaticProtocol",value:function(e){return r.get(l,e)}},{key:"removeStaticProtocol",value:function(e){r.remove(l,e)}},{key:"addStaticPlayer",value:function(e){u.push(e)}},{key:"getStaticPlayer",value:function(e){return r.get(u,e)}},{key:"removeStaticPlayer",value:function(e){r.remove(u,e)}},{key:"addStaticPlayerProxy",value:function(e){c.push(e)}},{key:"getStaticPlayerProxy",value:function(e){return r.get(c,e)}},{key:"removeStaticPlayerProxy",value:function(e){r.remove(c,e)}}]),a}();o.Client=h;var y=function(r){function s(){i(this,s);var e=t(this,(s.__proto__||Object.getPrototypeOf(s)).call(this,"WebSocket-builtin"));return e.currentPosition=0,e.paused=!0,e.doSeek=!1,e}return n(s,o.Protocol),e(s,[{key:"connect",value:function(e,t){var n=this;this.socket=new WebSocket(e.url),this.socket.addEventListener("open",function(){t(),n.sendHello("comp500","test")}),this.socket.addEventListener("message",function(e){n.emit("message",e.data),e.data.split("\n").forEach(function(e){null!=e&&(e.length<1||n.parseMessage(e))})})}},{key:"command",value:function(e,t){console.log("command: ",e,t),"send"==e&&this.socket.send(JSON.stringify(t)),"setmeta"==e&&this.sendFile(t.duration,t.name),"settime"==e&&(this.currentPosition=t),"seek"==e&&(this.currentPosition=t,this.doSeek=!0),"pause"==e&&(this.paused=!0),"unpause"==e&&(this.paused=!1)}},{key:"parseMessage",value:function(e){var t=JSON.parse(e);if(console.log("SERVER:",t),t.Error&&console.log("err",t.Error),t.Hello){console.log("hello",t.Hello),this.serverDetails={version:t.Hello.version,realversion:t.Hello.realversion,features:t.Hello.features,motd:t.Hello.motd};var n="Connected to server, version "+t.Hello.version+".";t.Hello.motd&&(n+=" MOTD:\n\t\t\t\t"+t.Hello.motd),this.emit("connected",n)}if(t.Set&&console.log("set",t.Set),t.List&&(console.log("list",t.List),console.log("roomsList",Object.keys(t.List)),console.log("userList",Object.keys(t.List[this.currentRoom]))),t.State&&(null!=t.State.ping.yourLatency&&(this.clientRtt=t.State.ping.yourLatency),this.latencyCalculation=t.State.ping.latencyCalculation,t.State.ignoringOnTheFly&&t.State.ignoringOnTheFly.server&&(this.serverIgnoringOnTheFly=t.State.ignoringOnTheFly.server,this.clientIgnoringOnTheFly=0,this.stateChanged=!1),t.State.playstate&&t.State.playstate.setBy&&t.State.playstate.setBy!=this.currentUsername)){var i=t.State.playstate.doSeek;i||(i=!1),i&&!this.doSeek&&this.emit("seek",t.State.playstate.position),this.paused!=t.State.playstate.paused&&(t.State.playstate.paused?(this.emit("pause"),this.paused=!0):(this.emit("unpause"),this.paused=!1))}this.sendState()}},{key:"sendState",value:function(){var e=0==this.clientIgnoringOnTheFly||0!=this.serverIgnoringOnTheFly,t={};t.State={},e&&(t.State.playstate={},t.State.playstate.position=this.currentPosition,t.State.playstate.paused=this.paused,this.doSeek&&(t.State.playstate.doSeek=!0,this.doSeek=!1)),t.State.ping={},t.State.ping.latencyCalculation=this.latencyCalculation,t.State.ping.clientLatencyCalculation=Date.now()/1e3,t.State.ping.clientRtt=this.clientRtt,this.stateChanged&&(this.clientIgnoringOnTheFly+=1),(this.serverIgnoringOnTheFly>0||this.clientIgnoringOnTheFly>0)&&(t.State.ignoringOnTheFly={},this.serverIgnoringOnTheFly>0&&(t.State.ignoringOnTheFly.server=this.serverIgnoringOnTheFly,this.serverIgnoringOnTheFly=0),this.clientIgnoringOnTheFly>0&&(t.State.ignoringOnTheFly.client=this.clientIgnoringOnTheFly)),console.log(t),this.command("send",t)}},{key:"sendHello",value:function(e,t,n){this.currentUsername=e,this.currentRoom=t;var i={Hello:{username:e,room:{name:t},version:"1.5.1"}};n&&(i.Hello.password=n),this.command("send",i)}},{key:"sendListRequest",value:function(){this.command("send",{List:null})}},{key:"sendReady",value:function(e){var t={Set:{ready:{isReady:e,manuallyInitiated:!0,username:this.currentUsername}}};this.command("send",t)}},{key:"sendFile",value:function(e,t){var n={duration:e,name:t,size:1};this.command("send",{Set:{file:n}})}}]),s}();o.Client.addStaticProtocol(new y),window.SyncWeb=o}();
//# sourceMappingURL=syncweb.min.js.map
