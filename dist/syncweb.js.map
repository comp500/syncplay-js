{"version":3,"sources":["syncweb.js","index.js","ArrayHandlers.js","EventEmitter.js","Protocol.js","Player.js","PlayerProxy.js","Client.js","WebSocketProtocol.js","export.js"],"names":["SyncWeb","get","remove","index","callback","totalList","player","playerProxy","protocol","ArrayHandlers","fetchedProtocol","staticProtocolList","staticPlayerList","staticPlayerProxyList","e","console","version","realversion","features","motd","connectedString","Object","details","name","message","output","username","packet","isReady","manuallyInitiated","file","window"],"mappings":";AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;ACTA;AACA;AACAA;ACFA;AACAC;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEAC;AACA;AACA;AACAC;AACA;AACA;AACA;AACAA;AACA;AACA;AACA;AAzBA;AFuCA;AEXAH;AFaA;AACA;AGzCA;AAAA;AH4CA;AG3CA;AACA;AACA;AH6CA;AACA;AACA;AACA;AG7CA;AACA;AACA;AACA;AACA;AH+CA;AACA;AACA;AG/CA;AHiDA;AGhDA;AACAI;AACA;AACA;AACA;AACA;AHkDA;AACA;AACA;AGjDA;AACA;AHmDA;AACA;AACA;AGlDA;AHoDA;AGlDA;AACA;AACAC;AACA;AACAA;AACA;AACAA;AACA;AACA;AACA;AHoDA;AGlDA;AACAA;AACA;AHoDA;AGlDA;AACA;AHoDA;AACA;AACA;AGnDA;AACA;AHqDA;AGnDA;AACA;AACA;AHqDA;AACA;AACA;AACA;AACA;AGtDAL;ACvDA;AJgHA;AACA;AACA;AACA;AIhHA;AAAA;AJmHA;AInHA;AJqHA;AInHA;AAFA;AAGA;AJsHA;AACA;AACA;AACA;AItHA;AACA;AJwHA;AACA;AACA;AACA;AACA;AIzHAA;ACbA;ALyIA;AACA;AACA;AACA;AKzIA;AAAA;AL4IA;AK5IA;AL8IA;AK5IA;AAFA;AAGA;AL+IA;AACA;AACA;AACA;AK/IA;AACA;ALiJA;AACA;AACA;AACA;AACA;AKlJAA;ALoJA;AACA;AMjKA;AAAA;ANoKA;AMnKA;AACA;ANqKA;AACA;AACA;AACA;AMrKA;AACA;ANuKA;AACA;AACA;AACA;AACA;AMxKAA;ACVA;APqLA;AOnLA;AACA;AACA;APqLA;AACA;AACA;AACA;AOrLA;AAAA;APwLA;AOxLA;AP0LA;AOxLA;AACA;AACA;AACA;AACA;AP0LA;AOxLA;AACAM;AACA;AP0LA;AOxLA;AACAC;AACA;AP0LA;AOxLA;AACAC;AACA;AAlBA;AAmBA;AP2LA;AACA;AACA;AACA;AO3LA;AACAA;AACA;AP6LA;AACA;AACA;AO5LA;AACA;AP8LA;AACA;AACA;AO7LAC;AACA;AP+LA;AACA;AACA;AOlLA;AACAH;AACA;APoLA;AACA;AACA;AOnLA;AACA;APqLA;AACA;AACA;AOpLAG;AACA;APsLA;AACA;AACA;AOzKA;AACAF;AACA;AP2KA;AACA;AACA;AO1KA;AACA;AP4KA;AACA;AACA;AO3KAE;AACA;AP6KA;AACA;AACA;AOjKA;APmKA;AOlKA;AACA;AACA;AACA;APoKA;AOlKA;AACA;AACA;AACA;APoKA;AOlKA;AACA;APoKA;AOlKA;AACAC;AACAA;AACA;AACA;APoKA;AOlKA;APoKA;AOlKAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;APoKA;AOlKA;APoKA;AACA;AACA;AACA;AOrKA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;APuKA;AACA;AACA;AOtKA;AACA;AACA;AACA;AACA;AACA;AACA;APwKA;AACA;AACA;AOvKA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;APyKA;AOvKA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;APyKA;AACA;AACA;AOrTAC;AACA;APuTA;AACA;AACA;AOtTA;AACA;APwTA;AACA;AACA;AOvTAF;AACA;APyTA;AACA;AACA;AO3SAG;AACA;AP6SA;AACA;AACA;AO5SA;AACA;AP8SA;AACA;AACA;AO7SAH;AACA;AP+SA;AACA;AACA;AOjSAI;AACA;APmSA;AACA;AACA;AOlSA;AACA;APoSA;AACA;AACA;AOnSAJ;AACA;APqSA;AACA;AACA;AACA;AACA;AOtNAT;APwNA;AACA;AACA;AACA;AQlZA;AAAA;ARqZA;AQrZA;ARuZA;AQpZA;AACA;AACA;AACA;AACA;AAPA;AAQA;ARuZA;AACA;AACA;AACA;AQxZA;AR0ZA;AQzZA;AR2ZA;AQzZA;AACAI;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AR2ZA;AQzZA;AACA;AACAU;AACA;AACA;AACA;AACA;AACA;AACA;AR2ZA;AACA;AACA;AQ1ZAC;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AA3BA;AA6BA;AR4ZA;AACA;AACA;AQ5ZA;AR8ZA;AQ7ZA;AACAA;AR+ZA;AQ7ZA;AACAA;AACA;AACA;AR+ZA;AQ7ZA;AACAA;AACA;AACA;AACAC;AACAC;AACAC;AACAC;AAJA;AAMA;AACA;AACAC;AAEA;AACA;AACA;AACA;AR8ZA;AQ5ZA;AACAL;AACA;AACA;AACAM;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACAA;AACA;AACA;AACAC;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AR8ZA;AQ5ZA;AACA;AACA;AR8ZA;AQ5ZA;AACA;AACA;AR8ZA;AQ5ZA;AACA;AACA;AACA;AR8ZA;AQ5ZA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AR8ZA;AQ5ZA;AACA;AACAC;AACAC;AAFA;AAIA;AR8ZA;AQ5ZA;AACA;AR8ZA;AACA;AACA;AQ7ZA;AACA;AACAC;AR+ZA;AQ7ZA;AACAA;AACAA;AACAA;AACA;AACAA;AACA;AACA;AACA;AR+ZA;AQ7ZAA;AACAA;AACAA;AACAA;AR+ZA;AQ7ZA;AAAA;AACA;AACA;ARgaA;AQ9ZA;AACAA;AACA;AACAA;AACA;AACA;AACA;AACAA;AACA;AACA;ARgaA;AQ9ZAV;ARgaA;AQ9ZA;AACA;ARgaA;AACA;AACA;AQ/ZA;AACA;ARiaA;AQ/ZA;AACA;AACAW;AACA;AACAH;AADA;AAGA;AALA;AADA;ARyaA;AQ/ZA;AACAI;AACA;ARiaA;AQ/ZA;AACA;ARiaA;AACA;AACA;AQhaA;AACA;ARkaA;AACA;AACA;AQjaA;AACA;AACA;AACAC;AACAC;AACAH;AAHA;AADA;AADA;AASA;AACA;ARmaA;AACA;AACA;AQlaA;AACA;AACA;AACA;AACA;AACA;AACAI;AADA;AADA;AAKA;ARoaA;AACA;AACA;AACA;AACA;AQraA;ARuaA;AACA;AQvaA9B;ACnSA+B","file":"syncweb.js","sourcesContent":[null,"/* eslint-disable no-unused-vars */\r\nlet SyncWeb = {};\r\nSyncWeb.util = {};","let ArrayHandlers = {\r\n\tget(array, content) {\r\n\t\tif (typeof content == \"string\") {\r\n\t\t\treturn array.find((itemFound) => {\r\n\t\t\t\treturn itemFound.name == content;\r\n\t\t\t});\r\n\t\t} else {\r\n\t\t\tif (array.includes(content)) {\r\n\t\t\t\treturn content;\r\n\t\t\t} else {\r\n\t\t\t\treturn undefined;\r\n\t\t\t}\r\n\t\t}\r\n\t},\r\n\r\n\tremove(array, content) {\r\n\t\tlet index;\r\n\t\tif (typeof content == \"string\") {\r\n\t\t\tindex = array.findIndex((itemFound) => {\r\n\t\t\t\treturn itemFound.name == content;\r\n\t\t\t});\r\n\t\t} else {\r\n\t\t\tindex = array.indexOf(content);\r\n\t\t}\r\n\t\tif (index > -1) array.splice(index, 1);\r\n\t}\r\n};\r\n\r\nSyncWeb.util.ArrayHandlers = ArrayHandlers;","class EventEmitter {\r\n\tconstructor() {\r\n\t\tthis.eventList = {};\r\n\t\tthis.activeEvents = true;\r\n\t}\r\n\r\n\ton(name, callback) {\r\n\t\tif (this.eventList[name] == null) {\r\n\t\t\tthis.eventList[name] = [];\r\n\t\t}\r\n\t\tthis.eventList[name].push(callback);\r\n\t}\r\n\r\n\tonce(name, callback) {\r\n\t\tlet modifiedCallback = (data) => {\r\n\t\t\tcallback(data);\r\n\t\t\tthis.removeListener(name, modifiedCallback);\r\n\t\t};\r\n\t\tthis.on(name, modifiedCallback);\r\n\t}\r\n\r\n\tany(callback) {\r\n\t\tthis.on(\"*\", callback);\r\n\t}\r\n\r\n\temit(name, data) {\r\n\t\tif (!this.activeEvents) return 0;\r\n\r\n\t\tlet totalList;\r\n\t\tif (this.eventList[name] && this.eventList[\"*\"]) {\r\n\t\t\ttotalList = this.eventList[name].concat(this.eventList[\"*\"]);\r\n\t\t} else if (this.eventList[name]) {\r\n\t\t\ttotalList = this.eventList[name];\r\n\t\t} else if (this.eventList[\"*\"]) {\r\n\t\t\ttotalList = this.eventList[\"*\"]\r\n\t\t} else {\r\n\t\t\treturn 0;\r\n\t\t}\r\n\r\n\t\tfor (let i = 0; i < totalList.length; i++) {\r\n\t\t\ttotalList[i](name, data);\r\n\t\t}\r\n\r\n\t\treturn totalList.length;\r\n\t}\r\n\r\n\tremoveListener(name, callback) {\r\n\t\t// TODO: find a way to gracefully report problems like this\r\n\t\tif (!this.eventList[name]) return;\r\n\r\n\t\tlet index = this.eventList[name].indexOf(callback);\r\n\t\tif (index > -1) this.eventList.splice(index, 1);\r\n\t}\r\n}\r\n\r\nSyncWeb.util.EventEmitter = EventEmitter;","/* global EventEmitter */\r\n\r\nclass Protocol extends EventEmitter {\r\n\tconstructor(name) {\r\n\t\tsuper();\r\n\t\tthis.name = name;\r\n\t}\r\n\r\n\tinitialise(client) {\r\n\t\tthis.client = client;\r\n\t}\r\n}\r\n\r\nSyncWeb.Protocol = Protocol;","/* global EventEmitter */\r\n\r\nclass Player extends EventEmitter {\r\n\tconstructor(name) {\r\n\t\tsuper();\r\n\t\tthis.name = name;\r\n\t}\r\n\r\n\tinitialise(client) {\r\n\t\tthis.client = client;\r\n\t}\r\n}\r\n\r\nSyncWeb.Player = Player;","class PlayerProxy {\r\n\tconstructor(name) {\r\n\t\tthis.name = name;\r\n\t}\r\n\r\n\tinitialise(client) {\r\n\t\tthis.client = client;\r\n\t}\r\n}\r\n\r\nSyncWeb.PlayerProxy = PlayerProxy;","/* global EventEmitter, ArrayHandlers */\r\n\r\nlet staticProtocolList = [];\r\nlet staticPlayerProxyList = [];\r\nlet staticPlayerList = [];\r\n\r\nclass Client extends EventEmitter {\r\n\tconstructor(playerElement) {\r\n\t\tsuper();\r\n\t\tthis.protocolList = staticProtocolList;\r\n\t\tthis.playerList = staticPlayerList;\r\n\t\tthis.playerProxyList = staticPlayerProxyList;\r\n\t\tthis.state = 0;\r\n\t\tthis.playerElement = playerElement;\r\n\r\n\t\tthis.playerList.forEach((player) => {\r\n\t\t\tplayer.initialise(this);\r\n\t\t});\r\n\r\n\t\tthis.playerProxyList.forEach((playerProxy) => {\r\n\t\t\tplayerProxy.initialise(this);\r\n\t\t});\r\n\r\n\t\tthis.protocolList.forEach((protocol) => {\r\n\t\t\tprotocol.initialise(this);\r\n\t\t});\r\n\t}\r\n\r\n\taddProtocol(protocol) {\r\n\t\tthis.protocolList.push(protocol);\r\n\t\tprotocol.initialise(this);\r\n\t}\r\n\r\n\tgetProtocol(protocol) {\r\n\t\treturn ArrayHandlers.get(this.protocolList, protocol);\r\n\t}\r\n\r\n\tremoveProtocol(protocol) {\r\n\t\tArrayHandlers.remove(this.protocolList, protocol);\r\n\t}\r\n\r\n\tstatic addStaticProtocol(protocol) {\r\n\t\tstaticProtocolList.push(protocol);\r\n\t}\r\n\r\n\tstatic getStaticProtocol(protocol) {\r\n\t\treturn ArrayHandlers.get(staticProtocolList, protocol);\r\n\t}\r\n\r\n\tstatic removeStaticProtocol(protocol) {\r\n\t\tArrayHandlers.remove(staticProtocolList, protocol);\r\n\t}\r\n\r\n\taddPlayer(player) {\r\n\t\tthis.playerList.push(player);\r\n\t\tplayer.initialise(this);\r\n\t}\r\n\r\n\tgetPlayer(player) {\r\n\t\treturn ArrayHandlers.get(this.playerList, player);\r\n\t}\r\n\r\n\tremovePlayer(player) {\r\n\t\tArrayHandlers.remove(this.playerList, player);\r\n\t}\r\n\r\n\tstatic addStaticPlayer(player) {\r\n\t\tstaticPlayerList.push(player);\r\n\t}\r\n\r\n\tstatic getStaticPlayer(player) {\r\n\t\treturn ArrayHandlers.get(staticPlayerList, player);\r\n\t}\r\n\r\n\tstatic removeStaticPlayer(player) {\r\n\t\tArrayHandlers.remove(staticPlayerList, player);\r\n\t}\r\n\r\n\taddPlayerProxy(playerProxy) {\r\n\t\tthis.playerProxyList.push(playerProxy);\r\n\t\tplayerProxy.initialise(this);\r\n\t}\r\n\r\n\tgetPlayerProxy(playerProxy) {\r\n\t\treturn ArrayHandlers.get(this.playerProxyList, playerProxy);\r\n\t}\r\n\r\n\tremovePlayerProxy(playerProxy) {\r\n\t\tArrayHandlers.remove(this.playerProxyList, playerProxy);\r\n\t}\r\n\r\n\tstatic addStaticPlayerProxy(playerProxy) {\r\n\t\tstaticPlayerProxyList.push(playerProxy);\r\n\t}\r\n\r\n\tstatic getStaticPlayerProxy(playerProxy) {\r\n\t\treturn ArrayHandlers.get(staticPlayerProxyList, playerProxy);\r\n\t}\r\n\r\n\tstatic removeStaticPlayerProxy(playerProxy) {\r\n\t\tArrayHandlers.remove(staticPlayerProxyList, playerProxy);\r\n\t}\r\n\r\n\tconnect(protocol, options) {\r\n\t\tif (this.state != 0) {\r\n\t\t\t// TODO: general error handler instead of throwing errors?\r\n\t\t\tthrow new Error(\"Client is currently connected, must disconnect first before reconnecting.\");\r\n\t\t}\r\n\r\n\t\tlet fetchedProtocol = this.getProtocol(protocol);\r\n\t\tif (fetchedProtocol == undefined || !fetchedProtocol) {\r\n\t\t\tthrow new Error(\"No protocol of that name is loaded!\");\r\n\t\t}\r\n\r\n\t\tthis.currentProtocol = fetchedProtocol;\r\n\t\tthis.state = 1;\r\n\r\n\t\tthis.proxyEvents(\"connecting\", protocol);\r\n\t\tfetchedProtocol.any(this.proxyEvents.bind(this));\r\n\t\tfetchedProtocol.on(\"seturl\", (event, url) => {\r\n\t\t\tthis.setURL(url);\r\n\t\t});\r\n\r\n\t\t// TODO: implement some sort of log system, for errors, connection progress etc.\r\n\r\n\t\tfetchedProtocol.connect(options, () => {\r\n\t\t\tif (this.state != 1) {\r\n\t\t\t\treturn; // ignore event if not in connecting state\r\n\t\t\t}\r\n\t\t\tthis.state = 2;\r\n\t\t\tthis.proxyEvents(\"connected\");\r\n\t\t});\r\n\t}\r\n\r\n\t// events relay status, such as \"connected\", \"connecting\" etc.\r\n\tproxyEvents(event, data) {\r\n\t\tfor (let i = 0; i < this.playerProxyList.length; i++) {\r\n\t\t\tthis.playerProxyList[i].event(event, data);\r\n\t\t}\r\n\t\tif (this.currentPlayer) {\r\n\t\t\t// players must not respond to seturl??\r\n\t\t\tthis.currentPlayer.event(event, data);\r\n\t\t}\r\n\t}\r\n\r\n\tproxyEventsToProtocol(event, data) {\r\n\t\tfor (let i = 0; i < this.playerProxyList.length; i++) {\r\n\t\t\tthis.playerProxyList[i].event(event, data);\r\n\t\t}\r\n\t\tif (this.currentProtocol) {\r\n\t\t\tthis.currentProtocol.event(event, data);\r\n\t\t}\r\n\t}\r\n\r\n\tsetURL(url) {\r\n\t\t// TODO: don't allow if not connected\r\n\t\tif (this.currentPlayer) {\r\n\t\t\t// TODO: what happens when a http player\r\n\t\t\t//       and yt player coexist? how do\r\n\t\t\t//       we choose which to use?\r\n\t\t\tif (this.currentPlayer.supports(url)) {\r\n\t\t\t\tthis.proxyEvents(\"seturl\", url);\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tlet foundPlayer = this.playerList.find((player) => {\r\n\t\t\treturn player.supports(url);\r\n\t\t});\r\n\t\tif (foundPlayer) {\r\n\t\t\t// if player is found, switch to it\r\n\t\t\tif (this.currentPlayer) this.currentPlayer.event(\"terminate\");\r\n\t\t\tthis.currentPlayer = foundPlayer;\r\n\t\t\tthis.currentPlayer.any(this.proxyEventsToProtocol.bind(this));\r\n\t\t\tthis.proxyEvents(\"seturl\", url);\r\n\t\t} else {\r\n\t\t\t// TODO: handle no players to play url\r\n\t\t\t//       catch-all player?\r\n\t\t\tthrow new Error(\"No players to handle URL available\");\r\n\t\t}\r\n\t}\r\n\t\r\n}\r\n\r\nSyncWeb.Client = Client;","class WebSocketProtocol extends SyncWeb.Protocol {\r\n\tconstructor() {\r\n\t\tsuper(\"WebSocket-builtin\");\r\n\r\n\t\tthis.currentPosition = 0.0;\r\n\t\tthis.paused = true;\r\n\t\tthis.doSeek = false;\r\n\t\tthis.isReady = false;\r\n\t\tthis.roomdetails = {};\r\n\t}\r\n\r\n\tconnect(options, callback) {\r\n\t\tthis.socket = new WebSocket(options.url);\r\n\r\n\t\tthis.socket.addEventListener(\"open\", () => {\r\n\t\t\tcallback();\r\n\t\t\tif (options.password) {\r\n\t\t\t\tthis.sendHello(options.name, options.room, options.password);\r\n\t\t\t} else {\r\n\t\t\t\tthis.sendHello(options.name, options.room);\r\n\t\t\t}\r\n\t\t\tthis.sendReady();\r\n\t\t\tthis.sendListRequest();\r\n\t\t});\r\n\r\n\t\tthis.socket.addEventListener(\"message\", (e) => {\r\n\t\t\tthis.emit(\"message\", e.data);\r\n\t\t\te.data.split(\"\\n\").forEach(messageText => {\r\n\t\t\t\tif (messageText == null) return;\r\n\t\t\t\tif (messageText.length < 1) return;\r\n\t\t\t\tthis.parseMessage(messageText);\r\n\t\t\t});\r\n\t\t});\r\n\t}\r\n\r\n\tevent(event, data) {\r\n\t\tconsole.log(\"event: \", event, data); // eslint-disable-line no-console\r\n\t\tswitch (event) {\r\n\t\t\tcase \"send\":\r\n\t\t\t\tthis.socket.send(JSON.stringify(data));\r\n\t\t\t\tbreak;\r\n\t\t\tcase \"setmeta\":\r\n\t\t\t\tthis.sendFile(data.duration, data.name);\r\n\t\t\t\tbreak;\r\n\t\t\tcase \"settime\":\r\n\t\t\t\tthis.currentPosition = data;\r\n\t\t\t\tbreak;\r\n\t\t\tcase \"seek\":\r\n\t\t\t\tthis.currentPosition = data;\r\n\t\t\t\tthis.doSeek = true;\r\n\t\t\t\tthis.sendState();\r\n\t\t\t\tbreak;\r\n\t\t\tcase \"pause\":\r\n\t\t\t\tthis.paused = true;\r\n\t\t\t\tthis.sendState();\r\n\t\t\t\tbreak;\r\n\t\t\tcase \"unpause\":\r\n\t\t\t\tthis.paused = false;\r\n\t\t\t\tif (!this.isReady) {\r\n\t\t\t\t\t// potential problem: unpause is sent from video.play()\r\n\t\t\t\t\t// could result in unintentional ready setting\r\n\t\t\t\t\tthis.isReady = true;\r\n\t\t\t\t\tthis.sendReady();\r\n\t\t\t\t}\r\n\t\t\t\tthis.sendState();\r\n\t\t}\r\n\t}\r\n\r\n\tparseMessage(message) {\r\n\t\tlet parsed = JSON.parse(message);\r\n\t\tconsole.log(\"SERVER:\", parsed); // eslint-disable-line no-console\r\n\r\n\t\tif (parsed.Error) {\r\n\t\t\tconsole.log(\"err\", parsed.Error); // eslint-disable-line no-console\r\n\t\t\t// TODO disconnect\r\n\t\t}\r\n\r\n\t\tif (parsed.Hello) {\r\n\t\t\tconsole.log(\"hello\", parsed.Hello); // eslint-disable-line no-console\r\n\t\t\t// TODO handle failed logins, etc.\r\n\t\t\tthis.serverDetails = {\r\n\t\t\t\tversion: parsed.Hello.version,\r\n\t\t\t\trealversion: parsed.Hello.realversion,\r\n\t\t\t\tfeatures: parsed.Hello.features,\r\n\t\t\t\tmotd: parsed.Hello.motd\r\n\t\t\t};\r\n\t\t\tlet connectedString = `Connected to server, version ${parsed.Hello.version}.`;\r\n\t\t\tif (parsed.Hello.motd) {\r\n\t\t\t\tconnectedString += ` MOTD:\r\n\t\t\t\t${parsed.Hello.motd}`;\r\n\t\t\t}\r\n\t\t\tthis.emit(\"connected\", connectedString);\r\n\t\t\t// roomEventRequest?\r\n\t\t}\r\n\r\n\t\tif (parsed.Set) {\r\n\t\t\tconsole.log(\"set\", parsed.Set); // eslint-disable-line no-console\r\n\t\t\t// TODO playlists\r\n\t\t\tif (parsed.Set.user) {\r\n\t\t\t\tObject.keys(parsed.Set.user).forEach((key) => {\r\n\t\t\t\t\tlet user = parsed.Set.user[key];\r\n\t\t\t\t\tif (user.event) {\r\n\t\t\t\t\t\tif (user.event.joined) {\r\n\t\t\t\t\t\t\tthis.emit(\"joined\", key);\r\n\t\t\t\t\t\t\tif (!this.roomdetails[user.room.name]) {\r\n\t\t\t\t\t\t\t\tthis.roomdetails[user.room.name] = {};\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\tthis.roomdetails[user.room.name][key] = {};\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tif (user.event.left) {\r\n\t\t\t\t\t\t\tthis.emit(\"left\", key);\r\n\t\t\t\t\t\t\tdelete this.roomdetails[user.room.name][key];\r\n\t\t\t\t\t\t\tif (Object.keys(this.roomdetails[user.room.name]).length == 0) {\r\n\t\t\t\t\t\t\t\tdelete this.roomdetails[user.room.name];\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\tif (this.roomdetails[user.room.name][key]) {\r\n\t\t\t\t\t\t\t// user hasn't moved\r\n\t\t\t\t\t\t} else {\r\n\t\t\t\t\t\t\t// eradicate all of this user\r\n\t\t\t\t\t\t\tlet details = {};\r\n\t\t\t\t\t\t\tObject.keys(this.roomdetails).some((room) => {\r\n\t\t\t\t\t\t\t\treturn Object.keys(this.roomdetails[room]).some((foundUser) => {\r\n\t\t\t\t\t\t\t\t\tif (foundUser == key) {\r\n\t\t\t\t\t\t\t\t\t\tdetails = this.roomdetails[room][foundUser];\r\n\t\t\t\t\t\t\t\t\t\tdelete this.roomdetails[room][foundUser];\r\n\t\t\t\t\t\t\t\t\t\tif (Object.keys(this.roomdetails[room]).length == 0) {\r\n\t\t\t\t\t\t\t\t\t\t\tdelete this.roomdetails[room];\r\n\t\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t\t\treturn true;\r\n\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t});\r\n\t\t\t\t\t\t\t});\r\n\t\t\t\t\t\t\tif (!this.roomdetails[user.room.name]) {\r\n\t\t\t\t\t\t\t\tthis.roomdetails[user.room.name] = {};\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\tthis.roomdetails[user.room.name][key] = details;\r\n\t\t\t\t\t\t\tthis.emit(\"moved\", {\"user\": key, \"room\": user.room.name});\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t\tif (user.file) {\r\n\t\t\t\t\t\tthis.roomdetails[user.room.name][key].file = user.file;\r\n\t\t\t\t\t}\r\n\t\t\t\t\tthis.emit(\"roomdetails\", this.roomdetails);\r\n\t\t\t\t});\r\n\t\t\t}\r\n\r\n\t\t\tif (parsed.Set.ready) {\r\n\t\t\t\tthis.roomdetails[parsed.Set.ready.username].isReady = parsed.Set.ready.isReady;\r\n\t\t\t\tthis.roomdetails[parsed.Set.ready.username].manuallyInitiated = parsed.Set.ready.manuallyInitiated;\r\n\r\n\t\t\t\tthis.emit(\"roomdetails\", this.roomdetails);\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tif (parsed.List) {\r\n\t\t\tthis.roomdetails = parsed.List;\r\n\t\t\tthis.emit(\"roomdetails\", parsed.List);\r\n\t\t}\r\n\r\n\t\tif (parsed.State) {\r\n\t\t\tif (parsed.State.ping.yourLatency != null) {\r\n\t\t\t\tthis.clientRtt = parsed.State.ping.yourLatency;\r\n\t\t\t}\r\n\t\t\tthis.latencyCalculation = parsed.State.ping.latencyCalculation;\r\n\t\t\tif (parsed.State.ignoringOnTheFly && parsed.State.ignoringOnTheFly.server) {\r\n\t\t\t\tthis.serverIgnoringOnTheFly = parsed.State.ignoringOnTheFly.server;\r\n\t\t\t\tthis.clientIgnoringOnTheFly = 0;\r\n\t\t\t\tthis.stateChanged = false;\r\n\t\t\t}\r\n\t\t\tif (parsed.State.playstate) {\r\n\t\t\t\tif (parsed.State.playstate.setBy && parsed.State.playstate.setBy != this.currentUsername) {\r\n\t\t\t\t\tif (parsed.State.playstate.doSeek && !this.doSeek) {\r\n\t\t\t\t\t\tthis.emit(\"seek\", parsed.State.playstate.position);\r\n\t\t\t\t\t}\r\n\t\t\t\t\tif (this.paused != parsed.State.playstate.paused) {\r\n\t\t\t\t\t\tif (parsed.State.playstate.paused) {\r\n\t\t\t\t\t\t\tthis.emit(\"pause\");\r\n\t\t\t\t\t\t\tthis.paused = true;\r\n\t\t\t\t\t\t} else {\r\n\t\t\t\t\t\t\tthis.emit(\"unpause\");\r\n\t\t\t\t\t\t\tthis.paused = false;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tif (parsed.Chat) {\r\n\t\t\tthis.emit(\"chat\", {\r\n\t\t\t\tname: parsed.Chat.username,\r\n\t\t\t\tmessage: parsed.Chat.message\r\n\t\t\t});\r\n\t\t}\r\n\r\n\t\tthis.sendState();\r\n\t}\r\n\r\n\tsendState() {\r\n\t\tlet clientIgnoreIsNotSet = (this.clientIgnoringOnTheFly == 0 || this.serverIgnoringOnTheFly != 0);\r\n\t\tlet output = {};\r\n\t\toutput.State = {};\r\n\r\n\t\tif (clientIgnoreIsNotSet) {\r\n\t\t\toutput.State.playstate = {};\r\n\t\t\toutput.State.playstate.position = this.currentPosition;\r\n\t\t\toutput.State.playstate.paused = this.paused;\r\n\t\t\tif (this.doSeek) {\r\n\t\t\t\toutput.State.playstate.doSeek = true;\r\n\t\t\t\tthis.doSeek = false;\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\toutput.State.ping = {};\r\n\t\toutput.State.ping.latencyCalculation = this.latencyCalculation;\r\n\t\toutput.State.ping.clientLatencyCalculation = Date.now() / 1000;\r\n\t\toutput.State.ping.clientRtt = this.clientRtt;\r\n\r\n\t\tif (this.stateChanged) { // TODO update this properly\r\n\t\t\tthis.clientIgnoringOnTheFly += 1;\r\n\t\t}\r\n\r\n\t\tif (this.serverIgnoringOnTheFly > 0 || this.clientIgnoringOnTheFly > 0) {\r\n\t\t\toutput.State.ignoringOnTheFly = {};\r\n\t\t\tif (this.serverIgnoringOnTheFly > 0) {\r\n\t\t\t\toutput.State.ignoringOnTheFly.server = this.serverIgnoringOnTheFly;\r\n\t\t\t\tthis.serverIgnoringOnTheFly = 0;\r\n\t\t\t}\r\n\t\t\tif (this.clientIgnoringOnTheFly > 0) {\r\n\t\t\t\toutput.State.ignoringOnTheFly.client = this.clientIgnoringOnTheFly;\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tconsole.log(output); // eslint-disable-line no-console\r\n\r\n\t\tthis.event(\"send\", output);\r\n\t}\r\n\r\n\tsendHello(username, room, password) {\r\n\t\tthis.currentUsername = username;\r\n\t\tthis.currentRoom = room;\r\n\r\n\t\tlet packet = {\r\n\t\t\t\"Hello\": {\r\n\t\t\t\tusername,\r\n\t\t\t\t\"room\": {\r\n\t\t\t\t\tname: room\r\n\t\t\t\t},\r\n\t\t\t\t\"version\": \"1.5.1\"\r\n\t\t\t}\r\n\t\t};\r\n\r\n\t\tif (password) {\r\n\t\t\tpacket.Hello.password = password;\r\n\t\t}\r\n\r\n\t\tthis.event(\"send\", packet);\r\n\t}\r\n\r\n\tsendListRequest() {\r\n\t\tthis.event(\"send\", {\"List\": null});\r\n\t}\r\n\r\n\tsendReady() {\r\n\t\tlet packet = {\r\n\t\t\t\"Set\": {\r\n\t\t\t\t\"ready\": {\r\n\t\t\t\t\tisReady: this.isReady,\r\n\t\t\t\t\tmanuallyInitiated: true,\r\n\t\t\t\t\tusername: this.currentUsername\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t};\r\n\t\tthis.event(\"send\", packet);\r\n\t}\r\n\r\n\tsendFile(duration, name) {\r\n\t\t// TODO size attribute for non-html5 video players?\r\n\t\t// 0 means unknown duration\r\n\t\tif (!duration) duration = 0;\r\n\t\tlet file = {duration, name, size: 0};\r\n\t\tthis.event(\"send\", {\r\n\t\t\t\"Set\": {\r\n\t\t\t\tfile\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n}\r\n\r\n// Adds the protocol to SyncWeb statically, so every Client has it\r\nSyncWeb.Client.addStaticProtocol(new WebSocketProtocol());","window.SyncWeb = SyncWeb;"]}