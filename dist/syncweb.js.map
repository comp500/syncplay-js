{"version":3,"sources":["syncweb.js","index.js","EventEmitter.js","PingService.js","WebSocketProtocol.js","export.js"],"names":["SyncWeb","callback","totalList","data","e","file","ready","isReady","manuallyInitiated","username","console","version","realversion","features","motd","connectedString","Object","messageAge","output","name","packet","window"],"mappings":";AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;ACTA;AACA;AACAA;ADWA;AACA;AEbA;AAAA;AFgBA;AEfA;AACA;AACA;AFiBA;AACA;AACA;AACA;AEjBA;AACA;AACA;AACA;AACA;AFmBA;AACA;AACA;AEnBA;AFqBA;AEpBA;AACAC;AACA;AACA;AACA;AACA;AFsBA;AACA;AACA;AErBA;AACA;AFuBA;AACA;AACA;AEtBA;AFwBA;AEtBA;AACA;AACAC;AACA;AACAA;AACA;AACAA;AACA;AACA;AACA;AFwBA;AEpCA;AAAAC;AAAA;AFwCA;AE1BA;AAAA;AF6BA;AE5BA;AACA;AF8BA;AE5BA;AACA;AF8BA;AACA;AACA;AE7BA;AACA;AF+BA;AE7BA;AACA;AACA;AF+BA;AACA;AACA;AACA;AACA;AEhCAH;AFkCA;AACA;AGzFA;AAAA;AH4FA;AG3FA;AACA;AACA;AACA;AACA;AH6FA;AG3FA;AH6FA;AACA;AACA;AACA;AACA;AG/FA;AHiGA;AG/FA;AHiGA;AG/FA;AHiGA;AG/FA;AACA;AACA;AACA;AACA;AHiGA;AG/FA;AACA;AACA;AACA;AACA;AACA;AHiGA;AACA;AACA;AGhGA;AACA;AHkGA;AACA;AACA;AGjGA;AACA;AHmGA;AACA;AACA;AACA;AACA;AGpGAA;ACtCA;AJ6IA;AACA;AACA;AACA;AI7IA;AAAA;AJgJA;AIhJA;AJkJA;AIhJA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAXA;AAYA;AJmJA;AIjJA;AJmJA;AACA;AACA;AACA;AIpJA;AJsJA;AIrJA;AJuJA;AIrJA;AACAC;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AJuJA;AIrJA;AACA;AACAG;AACA;AACA;AACA;AACA;AACA;AACA;AJuJA;AACA;AACA;AItJA;AACA;AACA;AACA;AACA;AJwJA;AACA;AACA;AIvJA;AACA;AJyJA;AACA;AACA;AIxJA;AACA;AJ0JA;AACA;AACA;AIzJA;AACA;AACA;AACA;AJ2JA;AACA;AACA;AI1JA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AJ4JA;AACA;AACA;AI3JA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACAC;AADA;AADA;AAKA;AACA;AACA;AJ6JA;AACA;AACA;AI5JA;AACAC;AACA;AACA;AACA;AACA;AACAC;AACAC;AACAC;AAHA;AADA;AADA;AASA;AACA;AJ8JA;AI5JA;AJ8JA;AACA;AACA;AACA;AI9JA;AACAC;AJgKA;AI9JA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AJgKA;AI9JA;AACA;AJgKA;AACA;AACA;AI/JAA;AACA;AACA;AJiKA;AACA;AACA;AIhKAA;AACA;AACA;AACAC;AACAC;AACAC;AACAC;AAJA;AAMA;AACA;AACAC;AAEA;AACA;AACA;AACA;AJiKA;AACA;AACA;AIjKA;AJmKA;AIlKAL;AACA;AACA;AACAM;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AJoKA;AIlKA;AACA;AACA;AACA;AACA;AACA;AJoKA;AIlKA;AACA;AJoKA;AIlKA;AACA;AACA;AJoKA;AACA;AACA;AIpKA;AJsKA;AIrKA;AACAA;AACAA;AACA;AACA;AACA;AACA;AACA;AACA;AJuKA;AACA;AACA;AItKA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACAC;AACA;AJwKA;AItKA;AACA;AACA;AACA;AJwKA;AItKA;AACA;AJwKA;AACA;AACA;AIvKA;AACA;AJyKA;AACA;AACA;AIxKA;AACA;AACAC;AJ0KA;AIxKA;AACAA;AACAA;AACAA;AACA;AACAA;AACA;AACA;AACA;AJ0KA;AIxKAA;AACA;AACAA;AACA;AACAA;AACAA;AJ0KA;AIxKA;AAAA;AACA;AACA;AJ2KA;AIzKA;AACAA;AACA;AACAA;AACA;AACA;AACA;AACAA;AACA;AACA;AJ2KA;AIzKAR;AJ2KA;AIzKA;AACA;AJ2KA;AACA;AACA;AI1KA;AACA;AJ4KA;AI1KA;AACA;AACAD;AACA;AACAU;AADA;AAGA;AALA;AADA;AJoLA;AI1KA;AACAC;AACA;AJ4KA;AI1KA;AACA;AJ4KA;AACA;AACA;AI3KA;AACA;AJ6KA;AACA;AACA;AACA;AACA;AI9KApB;AC7UAqB","file":"syncweb.js","sourcesContent":[null,"/* eslint-disable no-unused-vars */\r\nlet SyncWeb = {};\r\nSyncWeb.util = {};","class EventEmitter {\r\n\tconstructor() {\r\n\t\tthis.eventList = {};\r\n\t\tthis.activeEvents = true;\r\n\t}\r\n\r\n\ton(name, callback) {\r\n\t\tif (this.eventList[name] == null) {\r\n\t\t\tthis.eventList[name] = [];\r\n\t\t}\r\n\t\tthis.eventList[name].push(callback);\r\n\t}\r\n\r\n\tonce(name, callback) {\r\n\t\tlet modifiedCallback = (data) => {\r\n\t\t\tcallback(data);\r\n\t\t\tthis.removeListener(name, modifiedCallback);\r\n\t\t};\r\n\t\tthis.on(name, modifiedCallback);\r\n\t}\r\n\r\n\tany(callback) {\r\n\t\tthis.on(\"*\", callback);\r\n\t}\r\n\r\n\temit(name, ...data) {\r\n\t\tif (!this.activeEvents) return 0;\r\n\r\n\t\tlet totalList;\r\n\t\tif (this.eventList[name] && this.eventList[\"*\"]) {\r\n\t\t\ttotalList = this.eventList[name].concat(this.eventList[\"*\"]);\r\n\t\t} else if (this.eventList[name]) {\r\n\t\t\ttotalList = this.eventList[name];\r\n\t\t} else if (this.eventList[\"*\"]) {\r\n\t\t\ttotalList = this.eventList[\"*\"]\r\n\t\t} else {\r\n\t\t\treturn 0;\r\n\t\t}\r\n\r\n\t\tfor (let i = 0; i < totalList.length; i++) {\r\n\t\t\ttotalList[i](...data);\r\n\t\t}\r\n\r\n\t\treturn totalList.length;\r\n\t}\r\n\r\n\tremoveListener(name, callback) {\r\n\t\t// TODO: find a way to gracefully report problems like this\r\n\t\tif (!this.eventList[name]) return;\r\n\r\n\t\tlet index = this.eventList[name].indexOf(callback);\r\n\t\tif (index > -1) this.eventList.splice(index, 1);\r\n\t}\r\n}\r\n\r\nSyncWeb.util.EventEmitter = EventEmitter;","class PingService {\r\n\tconstructor() {\r\n\t\tthis.pingMovingAverageWeight = 0.85;\r\n\t\tthis.roundTripTime = 0;\r\n\t\tthis.forwardDelay = 0;\r\n\t\tthis.averageRTT = 0;\r\n\t}\r\n\r\n\t// Directly ported from python implementation\r\n\treceiveMessage(timestamp, senderRTT) {\r\n\t\tif (!timestamp) return;\r\n\r\n\t\tthis.roundTripTime = (Date.now() / 1000) - timestamp;\r\n\r\n\t\tif (this.roundTripTime < 0 || senderRTT < 0) return;\r\n\r\n\t\tif (!this.averageRTT) {\r\n\t\t\tthis.averageRTT = this.roundTripTime;\r\n\t\t}\r\n\t\t// Add to moving average\r\n\t\tthis.averageRTT = (this.averageRTT * this.pingMovingAverageWeight) + (this.roundTripTime * (1 - this.pingMovingAverageWeight));\r\n\r\n\t\tif (senderRTT < this.roundTripTime) {\r\n\t\t\tthis.forwardDelay = (this.averageRTT / 2) + (this.roundTripTime - senderRTT);\r\n\t\t} else {\r\n\t\t\tthis.forwardDelay = this.averageRTT / 2;\r\n\t\t}\r\n\t}\r\n\r\n\tgetLastForwardDelay() {\r\n\t\treturn this.forwardDelay;\r\n\t}\r\n\r\n\tgetRTT() {\r\n\t\treturn this.roundTripTime;\r\n\t}\r\n}\r\n\r\nSyncWeb.util.PingService = PingService;","/* global EventEmitter, PingService */\r\n\r\nclass WebSocketProtocol extends EventEmitter {\r\n\tconstructor() {\r\n\t\tsuper();\r\n\t\tthis.currentPosition = 0;\r\n\t\tthis.paused = true;\r\n\t\tthis.doSeek = false;\r\n\t\tthis.isReady = false;\r\n\t\tthis.roomdetails = {};\r\n\t\tthis.clientIgnoringOnTheFly = 0;\r\n\t\tthis.serverIgnoringOnTheFly = 0;\r\n\t\tthis.pingService = new PingService();\r\n\t\tthis.serverPosition = 0;\r\n\t\tthis.updateToServer = true;\r\n\t}\r\n\r\n\t// Public API\r\n\r\n\tconnect(options, callback) {\r\n\t\tthis.socket = new WebSocket(options.url);\r\n\r\n\t\tthis.socket.addEventListener(\"open\", () => {\r\n\t\t\tcallback();\r\n\t\t\tif (options.password) {\r\n\t\t\t\tthis.sendHello(options.name, options.room, options.password);\r\n\t\t\t} else {\r\n\t\t\t\tthis.sendHello(options.name, options.room);\r\n\t\t\t}\r\n\t\t\tthis.sendReady();\r\n\t\t\tthis.sendListRequest();\r\n\t\t\tif (this.currentFile) {\r\n\t\t\t\tthis.sendFile();\r\n\t\t\t}\r\n\t\t});\r\n\r\n\t\tthis.socket.addEventListener(\"message\", (e) => {\r\n\t\t\tthis.emit(\"message\", e.data);\r\n\t\t\te.data.split(\"\\n\").forEach(messageText => {\r\n\t\t\t\tif (messageText == null) return;\r\n\t\t\t\tif (messageText.length < 1) return;\r\n\t\t\t\tthis.parseMessage(messageText);\r\n\t\t\t});\r\n\t\t});\r\n\t}\r\n\r\n\tdisconnect() {\r\n\t\tif (this.socket) {\r\n\t\t\tthis.socket.close();\r\n\t\t\tdelete this.socket;\r\n\t\t}\r\n\t}\r\n\r\n\tsendData(data) {\r\n\t\tthis.socket.send(JSON.stringify(data));\r\n\t}\r\n\r\n\tsetTime(position) {\r\n\t\tthis.currentPosition = position;\r\n\t}\r\n\r\n\tseekTo(position) {\r\n\t\tthis.setTime(position);\r\n\t\tthis.doSeek = true;\r\n\t\tthis.sendState();\r\n\t}\r\n\r\n\tsetPause(pause) {\r\n\t\tthis.paused = pause;\r\n\t\tif (!pause && !this.isReady) {\r\n\t\t\t// potential problem: unpause is sent from video.play()\r\n\t\t\t// could result in unintentional ready setting\r\n\t\t\tthis.isReady = true;\r\n\t\t\tthis.sendReady();\r\n\t\t}\r\n\t\tthis.sendState();\r\n\t}\r\n\r\n\tsendFile(duration, name) {\r\n\t\tif (name) {\r\n\t\t\t// TODO size attribute for non-html5 video players?\r\n\t\t\t// 0 means unknown duration\r\n\t\t\tif (!duration) duration = 0;\r\n\t\t\tthis.currentFile = {duration, name, size: 0};\r\n\t\t}\r\n\t\tif (this.currentFile) {\r\n\t\t\tthis.sendData({\r\n\t\t\t\t\"Set\": {\r\n\t\t\t\t\tfile: this.currentFile\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t\tthis.sendListRequest();\r\n\t\t}\r\n\t}\r\n\r\n\tsendReady(ready) {\r\n\t\tif (ready == undefined || ready == null) {\r\n\t\t\tready = this.isReady;\r\n\t\t}\r\n\t\tlet packet = {\r\n\t\t\t\"Set\": {\r\n\t\t\t\t\"ready\": {\r\n\t\t\t\t\tisReady: ready,\r\n\t\t\t\t\tmanuallyInitiated: true,\r\n\t\t\t\t\tusername: this.currentUsername\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t};\r\n\t\tthis.sendData(packet);\r\n\t}\r\n\r\n\t// Private API\r\n\r\n\tparseMessage(message) {\r\n\t\tlet parsed = JSON.parse(message);\r\n\t\tconsole.log(\"SERVER:\", parsed); // eslint-disable-line no-console\r\n\r\n\t\tif (parsed.Error) {\r\n\t\t\tthis.parseError(parsed.Error);\r\n\t\t}\r\n\t\tif (parsed.Hello) {\r\n\t\t\tthis.parseHello(parsed.Hello);\r\n\t\t}\r\n\t\tif (parsed.Set) {\r\n\t\t\tthis.parseSet(parsed.Set);\r\n\t\t}\r\n\t\tif (parsed.List) {\r\n\t\t\tthis.parseList(parsed.List);\r\n\t\t}\r\n\t\tif (parsed.State) {\r\n\t\t\tthis.parseState(parsed.State);\r\n\t\t}\r\n\t\tif (parsed.Chat) {\r\n\t\t\tthis.parseChat(parsed.Chat);\r\n\t\t}\r\n\r\n\t\tthis.sendState();\r\n\t}\r\n\r\n\tparseError(data) {\r\n\t\tconsole.log(\"err\", data); // eslint-disable-line no-console\r\n\t\t// TODO disconnect\r\n\t}\r\n\r\n\tparseHello(data) {\r\n\t\tconsole.log(\"hello\", data); // eslint-disable-line no-console\r\n\t\t// TODO handle failed logins, etc.\r\n\t\tthis.serverDetails = {\r\n\t\t\tversion: data.version,\r\n\t\t\trealversion: data.realversion,\r\n\t\t\tfeatures: data.features,\r\n\t\t\tmotd: data.motd\r\n\t\t};\r\n\t\tlet connectedString = `Connected to server, version ${data.version}.`;\r\n\t\tif (data.motd) {\r\n\t\t\tconnectedString += ` MOTD:\r\n\t\t\t${data.motd}`;\r\n\t\t}\r\n\t\tthis.emit(\"connected\", connectedString);\r\n\t\t// roomEventRequest?\r\n\t}\r\n\r\n\tparseSet(data) {\r\n\t\tconsole.log(\"set\", data); // eslint-disable-line no-console\r\n\t\t// TODO playlists\r\n\t\tif (data.user) {\r\n\t\t\tObject.keys(data.user).forEach((key) => {\r\n\t\t\t\tlet user = data.user[key];\r\n\t\t\t\tif (user.event) {\r\n\t\t\t\t\tif (user.event.joined) {\r\n\t\t\t\t\t\tthis.emit(\"joined\", key, user.room.name);\r\n\t\t\t\t\t\tthis.roomdetails[key] = {room: user.room.name};\r\n\t\t\t\t\t}\r\n\t\t\t\t\tif (user.event.left) {\r\n\t\t\t\t\t\tthis.emit(\"left\", key, user.room.name);\r\n\t\t\t\t\t\tdelete this.roomdetails[key];\r\n\t\t\t\t\t}\r\n\t\t\t\t} else {\r\n\t\t\t\t\tif (this.roomdetails[key] && this.roomdetails[key].room != user.room.name) {\r\n\t\t\t\t\t\t// user has moved\r\n\t\t\t\t\t\tthis.roomdetails[key].room = user.room.name;\r\n\t\t\t\t\t\tthis.emit(\"moved\", key, user.room.name);\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\tif (user.file) {\r\n\t\t\t\t\tthis.roomdetails[key].file = user.file;\r\n\t\t\t\t}\r\n\t\t\t\tthis.emit(\"roomdetails\", this.roomdetails);\r\n\t\t\t});\r\n\t\t}\r\n\r\n\t\tif (data.ready) {\r\n\t\t\tif (!this.roomdetails[data.ready.username]) {\r\n\t\t\t\tthis.roomdetails[data.ready.username] = {};\r\n\t\t\t} \r\n\t\t\tthis.roomdetails[data.ready.username].isReady = data.ready.isReady;\r\n\t\t\tthis.roomdetails[data.ready.username].manuallyInitiated = data.ready.manuallyInitiated;\r\n\r\n\t\t\tthis.emit(\"roomdetails\", this.roomdetails);\r\n\t\t}\r\n\r\n\t\t// to implement:\r\n\t\t// room, controllerAuth, newControlledRoom, playlistIndex, playlistChange\r\n\t}\r\n\r\n\tparseList(data) {\r\n\t\tthis.roomdetails = {};\r\n\t\tObject.keys(data).forEach((room) => {\r\n\t\t\tObject.keys(data[room]).forEach((user) => {\r\n\t\t\t\tthis.roomdetails[user] = data[room][user];\r\n\t\t\t\tthis.roomdetails[user].room = room;\r\n\t\t\t});\r\n\t\t});\r\n\t\tthis.emit(\"roomdetails\", data);\r\n\t}\r\n\r\n\tparseState(data) {\r\n\t\tlet messageAge = 0;\r\n\t\tif (data.ignoringOnTheFly && data.ignoringOnTheFly.server) {\r\n\t\t\tthis.serverIgnoringOnTheFly = data.ignoringOnTheFly.server;\r\n\t\t\tthis.clientIgnoringOnTheFly = 0;\r\n\t\t\tthis.stateChanged = false;\r\n\t\t}\r\n\t\tif (data.playstate) {\r\n\t\t\tif (data.playstate.setBy && data.playstate.setBy != this.currentUsername) {\r\n\t\t\t\tif (this.updateToServer || (data.playstate.doSeek && !this.doSeek)) {\r\n\t\t\t\t\tthis.emit(\"seek\", data.playstate.position, data.playstate.setBy);\r\n\t\t\t\t\tthis.updateToServer = false;\r\n\t\t\t\t}\r\n\t\t\t\tif (this.paused != data.playstate.paused) {\r\n\t\t\t\t\tif (data.playstate.paused) {\r\n\t\t\t\t\t\tthis.emit(\"pause\", data.playstate.setBy);\r\n\t\t\t\t\t\tthis.paused = true;\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\tthis.emit(\"unpause\", data.playstate.setBy);\r\n\t\t\t\t\t\tthis.paused = false;\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\tif (data.playstate.position) {\r\n\t\t\t\tthis.serverPosition = data.playstate.position;\r\n\t\t\t}\r\n\t\t}\r\n\t\tif (data.ping) {\r\n\t\t\tif (data.ping.latencyCalculation) {\r\n\t\t\t\tthis.latencyCalculation = data.ping.latencyCalculation;\r\n\t\t\t}\r\n\t\t\tif (data.ping.clientLatencyCalculation) {\r\n\t\t\t\tthis.pingService.receiveMessage(data.ping.clientLatencyCalculation, data.ping.serverRtt);\r\n\t\t\t}\r\n\t\t\tmessageAge = this.pingService.getLastForwardDelay();\r\n\t\t}\r\n\r\n\t\t// update position due to message delays\r\n\t\tif (!this.paused) {\r\n\t\t\tthis.serverPosition += messageAge;\r\n\t\t}\r\n\r\n\t\t// compare server position and client position, ffwd/rewind etc.\r\n\t}\r\n\r\n\tparseChat(data) {\r\n\t\tthis.emit(\"chat\", data.username, data.message);\r\n\t}\r\n\r\n\tsendState() {\r\n\t\tlet clientIgnoreIsNotSet = (this.clientIgnoringOnTheFly == 0 || this.serverIgnoringOnTheFly != 0);\r\n\t\tlet output = {};\r\n\t\toutput.State = {};\r\n\r\n\t\tif (clientIgnoreIsNotSet) {\r\n\t\t\toutput.State.playstate = {};\r\n\t\t\toutput.State.playstate.position = this.currentPosition;\r\n\t\t\toutput.State.playstate.paused = this.paused;\r\n\t\t\tif (this.doSeek) {\r\n\t\t\t\toutput.State.playstate.doSeek = true;\r\n\t\t\t\tthis.doSeek = false;\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\toutput.State.ping = {};\r\n\t\tif (this.latencyCalculation) {\r\n\t\t\toutput.State.ping.latencyCalculation = this.latencyCalculation;\r\n\t\t}\r\n\t\toutput.State.ping.clientLatencyCalculation = Date.now() / 1000;\r\n\t\toutput.State.ping.clientRtt = this.pingService.getRTT();\r\n\r\n\t\tif (this.stateChanged) { // TODO update this properly\r\n\t\t\tthis.clientIgnoringOnTheFly += 1;\r\n\t\t}\r\n\r\n\t\tif (this.serverIgnoringOnTheFly > 0 || this.clientIgnoringOnTheFly > 0) {\r\n\t\t\toutput.State.ignoringOnTheFly = {};\r\n\t\t\tif (this.serverIgnoringOnTheFly > 0) {\r\n\t\t\t\toutput.State.ignoringOnTheFly.server = this.serverIgnoringOnTheFly;\r\n\t\t\t\tthis.serverIgnoringOnTheFly = 0;\r\n\t\t\t}\r\n\t\t\tif (this.clientIgnoringOnTheFly > 0) {\r\n\t\t\t\toutput.State.ignoringOnTheFly.client = this.clientIgnoringOnTheFly;\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tconsole.log(output); // eslint-disable-line no-console\r\n\r\n\t\tthis.sendData(output);\r\n\t}\r\n\r\n\tsendHello(username, room, password) {\r\n\t\tthis.currentUsername = username;\r\n\t\tthis.currentRoom = room;\r\n\r\n\t\tlet packet = {\r\n\t\t\t\"Hello\": {\r\n\t\t\t\tusername,\r\n\t\t\t\t\"room\": {\r\n\t\t\t\t\tname: room\r\n\t\t\t\t},\r\n\t\t\t\t\"version\": \"1.5.1\"\r\n\t\t\t}\r\n\t\t};\r\n\r\n\t\tif (password) {\r\n\t\t\tpacket.Hello.password = password;\r\n\t\t}\r\n\r\n\t\tthis.sendData(packet);\r\n\t}\r\n\r\n\tsendListRequest() {\r\n\t\tthis.sendData({\"List\": null});\r\n\t}\r\n}\r\n\r\nSyncWeb.Client = WebSocketProtocol;","window.SyncWeb = SyncWeb;"]}